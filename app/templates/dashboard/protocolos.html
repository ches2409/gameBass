{% extends 'dashboard/index.html' %}

{% block title %}Protocolos | Arkadex{% endblock %}

{% block dashboard_body %}

    {% from 'macros/data_card_macro.html' import render_data_card with context %}
    {% from 'macros/protocolo_form_macro.html' import render_protocolo_modal %}

	{% block alertContainer %}
        {% if alert_finish %}
            {% with icon=alert_finish.icon, title=alert_finish.title, subtitle=alert_finish.subtitle, btn_info=alert_finish.btn_info, modal_target='createProtocoloModal' %}
                {% include 'components/alert-container.html' %}
            {% endwith %}
        {% endif %}

    {% endblock %}

    {% include 'components/header-section.html' %}

    <div class="protocolos_card">

        {% block protocolsCard %}
        	{% include 'components/protocols-card.html' %}
        {% endblock %}

    </div>

    {# Aquí irán los modales para crear y actualizar torneos en el futuro #}
    {{ render_protocolo_modal(
            modal_id='createProtocoloModal',
            form_action=url_for('protocolo.create'),
            submit_text="CONFIRMAR_INYECCIÓN",
            codigos_listado=codigos_listado,
            categorias_listado=categorias_listado,
            is_create=True
    ) }}
    {{ render_protocolo_modal(
            modal_id='updateProtocoloModal',
            form_action=url_for('protocolo.update', id_protocolo=0),
            submit_text="ACTUALIZAR_PROTOCOLO",
            codigos_listado=codigos_listado,
            categorias_listado=categorias_listado
    ) }}

    {% include 'components/delete-modal.html' %}

    <script>
        function toggleModal(modalID) {
            const modal = document.getElementById(modalID);
            if (modal) {
                if (modal.style.display === "none" || modal.style.display === "") {
                    modal.style.display = "flex";
                } else {
                    modal.style.display = "none";
                }
            }
        }

        function openUpdateModal(button) {
            // 1. Obtener datos del botón
            const id = button.getAttribute('data-id');
            const nombre = button.getAttribute('data-nombre');
            const codigo = button.getAttribute('data-codigo');
            const categoria = button.getAttribute('data-categoria');
            const descripcion = button.getAttribute('data-descripcion');

            // 2. Construir la URL de actualización dinámicamente
            // Usamos un ID '0' temporal para que Flask genere la base de la URL, y luego lo reemplazamos
            const form = document.getElementById('form-updateProtocoloModal');
            const baseUrl = "{{ url_for('protocolo.update', id_protocolo=0) }}";
            const updateUrl = baseUrl.replace('/0', '/' + id);

            // 3. Asignar al formulario y a los inputs
            form.action = updateUrl;
            document.getElementById('updateProtocoloModal-nombre').value = nombre;
            document.getElementById('updateProtocoloModal-codigo').value = codigo;
            document.getElementById('updateProtocoloModal-categoria').value = categoria;
            document.getElementById('updateProtocoloModal-descripcion').value = descripcion;

            // 4. Abrir el modal
            toggleModal('updateProtocoloModal');
        }

        function openDeleteModal(deleteUrl, itemName) {
            // 1. Actualizar el enlace del botón de confirmación
            document.getElementById('btnConfirmPurge').href = deleteUrl;

            // 2. Mostrar el nombre del item (protocolo) en la advertencia
            document.getElementById('deleteItemName').textContent = itemName;

            // 3. Abrir el modal
            toggleModal('deleteConfirmationModal');
        }


    </script>

{% endblock %}