{% extends 'dashboard/index.html' %}

{% block title %}VIRTUAL_SOFTWARE | GameBass{% endblock %}

{% block dashboard_body %}

    {% from 'macros/data_card_macro.html' import render_data_card with context %}
    {% from 'macros/usuario_form_macro.html' import render_usuario_modal %}

    {% block alertContainer %}
        {% if alert_finish %}
            {% with icon=alert_finish.icon, title=alert_finish.title, subtitle=alert_finish.subtitle, btn_info=alert_finish.btn_info, modal_target='createUserModal' %}
                {% include 'components/alert-container.html' %}
            {% endwith %}
        {% endif %}
    {% endblock %}

    {% include 'components/header-section.html' %}

    <!-- Contenedor para nuestras tarjetas, usando un grid para ordenarlas -->
    <div class="nodo-grid">
        {% if usuarios %}
            {% for usuario in usuarios %}
                {# Definimos las macros de contenido DENTRO del bucle para que tengan acceso a la variable 'usuario'. #}

                {% macro card_header_content() %}
                    <div class="engine-info text-2xs text-soft">
                        ID_{{ usuario.jerarquia.nombre_jerarquia | upper }}{{ usuario.jerarquia.nivel_acceso }}X{{ "%03d" | format(usuario.id_usuario) }}
                    </div>

                {% endmacro %}

                {% macro card_body_content() %}
                    <div class="user-avatar-container">
                    {% if usuario.foto_usuario %}
                    	{# Si el campo 'foto_usuario' empieza con 'http' es una URL completa. #}
                        {% if usuario.foto_usuario.startswith('http') %}
                            <img src="{{ usuario.foto_usuario }}" alt="avatar de {{ usuario.alias_usuario }}" class="user-avatar">
                        {% else %}
                            <img src="{{ url_for('static', filename='uploads/avatars/' ~ usuario.foto_usuario) }}" alt="avatar de {{ usuario.alias_usuario }}" class="user-avatar">
                        {% endif %}
                        {% else %}
                            {# Si no hay foto, se muestra un avatar generico por defecto. #}
                            <img src="https://api.dicebear.com/9.x/bottts-neutral/svg?seed={{ usuario.alias_usuario }}" class="user-avatar" alt="avatar por defecto">
                    {% endif %}
                    </div>
                    <div class="user-level-container">

                    <h5> <span class="text-2xs" >perfil de acceso</span> {{ Permissions.get_name(usuario.jerarquia.nivel_acceso) }}</h5>
                    <p class="text-xs">Nivel de autorizacion: {{ usuario.jerarquia.nivel_acceso }} </p>
                    </div>
                {% endmacro %}

                {{ render_data_card(usuario, card_type='usuario',
                    item_id=usuario.id_usuario,
                    item_name=usuario.alias_usuario,
                    neon_color=usuario.jerarquia.color_hex,
                    title=usuario.alias_usuario | upper,
                    profile='SISTEMA',
                    subtitle=usuario.email_usuario | upper,
                    edit_data_attributes={
                        'id': usuario.id_usuario,
                        'nombre': usuario.alias_usuario,
                        'email': usuario.email_usuario,
                        'jerarquia': usuario.id_jerarquia,
                        'foto': usuario.foto_usuario,
                        },
                    card_header_content=card_header_content,
                    card_body_content=card_body_content
                    )
                }}
            {% endfor %}
        {% else %}
            <!-- Mensaje si no hay ninguna jerarquía creada todavía -->

            <div class="error-container">
                {%  include 'components/error-datos.html'%}
            </div>

        {% endif %}
    </div>

    {# 2. Usamos la macro para renderizar el modal de CREACIÓN de usuario #}
    {{ render_usuario_modal(
        modal_id='createUserModal',
        form_action=url_for('usuario.create'),
        submit_text='INICIAR_INYECCION',
        jerarquias=jerarquias_list,
        is_create=True) }}

    {# 3. Usamos la MISMA macro para renderizar el modal de ACTUALIZACIÓN de usuario #}
    {{ render_usuario_modal(
        modal_id='updateUserModal',
        form_action=url_for('usuario.update', id_usuario=0),
        submit_text='ACTUALIZAR USUARIO',
        jerarquias=jerarquias_list)
    }}

     {% include 'components/delete-modal.html' %}

    <script>
        // Función genérica para abrir/cerrar cualquier modal
        function toggleModal(modalID) {
            const modal = document.getElementById(modalID);
            if (modal) {
                modal.style.display = (modal.style.display === "none" || modal.style.display === "") ? "flex" : "none";
            }
        }

        function openUpdateModal(button) {
            // 1. Obtener datos del botón
            const id = button.getAttribute('data-id');
            const nombre = button.getAttribute('data-nombre');
            const email = button.getAttribute('data-email');
            const jerarquia = button.getAttribute('data-jerarquia');
            const foto = button.getAttribute('data-foto');



            // 2. Construir la URL de actualización dinámicamente
            const form = document.getElementById('form-updateUserModal'); // ID del form ahora es único
            const baseUrl = "{{ url_for('usuario.update', id_usuario=0) }}"; // URL base con '0'
            const updateUrl = baseUrl.replace('/0', '/' + id); // Reemplazo seguro

            // 3. Asignar valores a los inputs del formulario
            form.action = updateUrl;
            // Prefijamos el ID del input con el ID del modal para asegurar unicidad
            document.getElementById('updateUserModal-alias').value = nombre;
            document.getElementById('updateUserModal-email').value = email;
            document.getElementById('updateUserModal-password').value = '';
            document.getElementById('updateUserModal-jerarquia').value = jerarquia;
            document.getElementById('updateUserModal-foto').value = ''; // Limpia el input de archivo.
            document.getElementById('updateUserModal-url').value = (foto && foto.startsWith('http')) ? foto : ''; // Rellena la URL si es una URL.




            // 4. Mostrar el modal
            toggleModal('updateUserModal');

        }

        function openDeleteModal(deleteUrl, itemName) {
            // 1. Actualizar el enlace del botón de confirmación
            document.getElementById('btnConfirmPurge').href = deleteUrl;

            // 2. Mostrar el nombre del rol en la advertencia
            document.getElementById('deleteItemName').textContent = itemName;

            // 3. Abrir el modal
            toggleModal('deleteConfirmationModal');
        }

    </script>

{% endblock %}