{% extends 'dashboard/index.html' %}

{% block title %}Jerarquías | Arkadex{% endblock %}

{% block dashboard_body %}
    {% from 'macros/data_card_macro.html' import render_data_card with context %}
    {% from 'macros/jerarquia_form_macro.html' import render_jerarquia_modal %}

    {% block alertContainer %}
        {% if alert_finish %}
            {% with icon=alert_finish.icon, title=alert_finish.title, subtitle=alert_finish.subtitle, btn_info=alert_finish.btn_info, modal_target='createJerarquiaModal' %}
                {% include 'components/alert-container.html' %}
            {% endwith %}
        {% endif %}
    {% endblock %}

    {% include 'components/header-section.html' %}

    <!-- Contenedor para nuestras tarjetas, usando un grid para ordenarlas -->
    <div class="nodo-grid">
        {% if jerarquias %}
            {% for jerarquia in jerarquias %}

                {% macro card_header_content() %}
                    <span class="id-tag counter">LVL_{{ jerarquia.nivel_acceso }}</span>
                {% endmacro %}

                {% macro card_body_content() %}
                    <p class="rank-description">{{ jerarquia.descripcion_jerarquia | truncate(120) }}</p>
                    <div class="item-tags">{% for protocolo in jerarquia.protocolos %}<span class="tag">{{ protocolo.codigo_protocolo.codigo }}</span>{% else %}<span class="tag tag-empty">SIN_PROTOCOLOS</span>{% endfor %}</div>
                {% endmacro %}

                {% macro card_footer_content() %}
                    <div class="stat-bar" style="--auth-weight: {{ jerarquia.nivel_acceso }}%;"><div class="fill"></div></div><span class="footer-label">AUTH_WEIGHT</span>
                {% endmacro %}

                {{ render_data_card(jerarquia, card_type='jerarquia',
                    item_id=jerarquia.id_jerarquia,
                    item_name=jerarquia.nombre_jerarquia,
                    neon_color=jerarquia.color_hex,
                    title=jerarquia.nombre_jerarquia,
                    subtitle=jerarquia.subtitulo_jerarquia,
                    profile='SISTEMA',
                    edit_data_attributes={'id': jerarquia.id_jerarquia, 'nombre': jerarquia.nombre_jerarquia, 'subtitulo': jerarquia.subtitulo_jerarquia, 'nivelJerarquia': jerarquia.nivel_acceso, 'colorJerarquia': jerarquia.color_hex, 'descripcionJerarquia': jerarquia.descripcion_jerarquia, 'protocolos': jerarquia.protocolos|map(attribute='id_protocolo')|join(',')},
                    card_header_content=card_header_content,
                    card_body_content=card_body_content,
                    card_footer_content=card_footer_content) }}
            {% endfor %}
        {% else %}
            <!-- Mensaje si no hay ninguna jerarquía creada todavía -->

            <div class="error-container">
                {%  include 'components/error-datos.html'%}
            </div>

        {% endif %}
    </div>

    {# Aquí irán los modales para crear y actualizar torneos en el futuro #}
    {{ render_jerarquia_modal(
            modal_id='createJerarquiaModal',
            form_action=url_for('jerarquia.create'),
            submit_text="CONFIRMAR_INYECCIÓN",
            protocolos=protocolos_listado,
            is_create=True
    ) }}
    {{ render_jerarquia_modal(
            modal_id='updateJerarquiaModal',
            form_action=url_for('jerarquia.update', id_jerarquia=0),
            submit_text="ACTUALIZAR_JERARQUIA",
            protocolos=protocolos_listado
    ) }}

    {% include 'components/delete-modal.html' %}

    <script>
        function toggleModal(modalID) {
            const modal = document.getElementById(modalID);
            if (modal) {
                modal.style.display = (modal.style.display === "none" || modal.style.display === "") ? "flex" : "none";
            }
        }

        function openUpdateModal(button) {
            // 1. Obtener datos del botón
            const id = button.getAttribute('data-id');
            const nombre = button.getAttribute('data-nombre');
            const subtitulo = button.getAttribute('data-subtitulo');
            const nivel = button.getAttribute('data-nivelJerarquia');
            const color = button.getAttribute('data-colorJerarquia');
            const descripcion = button.getAttribute('data-descripcionJerarquia');
            // Obtenemos la cadena de IDs: "1,5,12"
            const protocolosIdsStr = button.getAttribute('data-protocolos');

            // 2. Construir la URL de actualización dinámicamente
            const form = document.getElementById('form-updateJerarquiaModal');
            const baseUrl = "{{ url_for('jerarquia.update', id_jerarquia=0) }}"; // URL base con '0'
            const updateUrl = baseUrl.replace('/0', '/' + id); // Reemplazo seguro

            // 3. Asignar valores a los inputs del formulario
            form.action = updateUrl;
            document.getElementById('updateJerarquiaModal-nombre').value = nombre;
            document.getElementById('updateJerarquiaModal-subtitulo').value = subtitulo;
            document.getElementById('updateJerarquiaModal-nivelJerarquia').value = nivel;
            document.getElementById('updateJerarquiaModal-colorJerarquia').value = color;
            document.getElementById('updateJerarquiaModal-descripcionJerarquia').value = descripcion;

            // 4. Manejar los checkboxes de protocolos
            // Convertimos la cadena "1,5,12" en un array de strings: ["1", "5", "12"]
            const protocolosSeleccionados = protocolosIdsStr ? protocolosIdsStr.split(',') : [];

            // Obtenemos TODOS los checkboxes del modal de ACTUALIZACIÓN
            const allCheckboxes = document.querySelectorAll('#updateJerarquiaModal .hidden-checkbox');

            // Iteramos sobre todos los checkboxes para marcarlos o desmarcarlos
            allCheckboxes.forEach(checkbox => {
                // El .value del checkbox es un string. Comparamos si está en nuestro array.
                checkbox.checked = protocolosSeleccionados.includes(checkbox.value);
            });

            // 5. Abrir el modal
            toggleModal('updateJerarquiaModal');
        }
        function openDeleteModal(deleteUrl, itemName) {
            // 1. Actualizar el enlace del botón de confirmación
            document.getElementById('btnConfirmPurge').href = deleteUrl;

            // 2. Mostrar el nombre del rol en la advertencia
            document.getElementById('deleteItemName').textContent = itemName;

            // 3. Abrir el modal
            toggleModal('deleteConfirmationModal');
        }


    </script>

{% endblock %}