{% extends 'dashboard/index.html' %}

{% block title %}ARENA_OPERATIONS | GameBass{% endblock %}

{% block dashboard_body %}

    {% from 'macros/data_card_macro.html' import render_data_card with context %}
    {% from 'macros/torneo_form_macro.html' import render_torneo_modal %}


    {% block alertContainer %}
        {% if alert_finish %}
            {% with icon=alert_finish.icon, title=alert_finish.title, subtitle=alert_finish.subtitle, btn_info=alert_finish.btn_info, modal_target='createTorneoModal' %}
                {% include 'components/alert-container.html' %}
            {% endwith %}
        {% endif %}
    {% endblock %}

    {% include 'components/header-section.html' %}

    <!-- Contenedor para nuestras tarjetas, usando un grid para ordenarlas -->
    <div class="nodo-grid">
        {% if torneos_list %}
            {% for torneo in torneos_list %}
                {# Definimos las macros de contenido DENTRO del bucle para que tengan acceso a la variable 'torneo'. #}
                {% macro card_header_content() %}
{#                    <div class="engine-icon" style="border-color: {{ torneo.juego.color_juego }};"><span class="material-symbols-outlined" style="color: {{ torneo.juego.color_juego }};">emoji_events</span></div>#}
                    <span class="id-tag text-xl" style="color: {{ torneo.juego.color_juego }};">{{ torneo.juego.nombre_juego | upper }}</span>
                {% endmacro %}
{#
                {% macro card_body_content() %}
                    <div class="tech-specs">
                        <div class="spec-row"><span class="label">RECOMPENSA</span><span class="value">{{ torneo.recompensa_torneo }}</span></div>
                        <div class="spec-row"><span class="label">INICIO</span><span class="value">{{ torneo.fecha_inicio.strftime('%Y-%m-%d %H:%M') }}</span></div>
                        <div class="spec-row"><span class="label">FIN</span><span class="value">{{ torneo.fecha_fin.strftime('%Y-%m-%d %H:%M') }}</span></div>
                    </div>
                {% endmacro %}
#}
                {% macro card_body_content() %}
                    <div class="arena-wrapper">
                        <div class="arena-stat">
                            <p class="stat-label">Recompensa</p>
                            <p class="stat-value">{{ torneo.recompensa_torneo }}</p>
                        </div>

                        <div class="arena-stat secondary">
                            <p class="stat-label">Competidores</p>
                            <p class="stat-value">{{ torneo.registros|length }}/{{ torneo.max_competidores }}</p>
                        </div>

                    </div>

                    <div class="tech-specs">
                        <div class="spec-row"><span class="label">INICIO</span><span class="value">{{ torneo.fecha_inicio.strftime('%Y-%m-%d %H:%M') }}</span></div>
                        <div class="spec-row"><span class="label">FIN</span><span class="value">{{ torneo.fecha_fin.strftime('%Y-%m-%d %H:%M') }}</span></div>
                    </div>

                {% endmacro %}



                {% macro card_footer_content() %}
                    <div class="status-tournament">
                        <span class="value status-{{ torneo.estado_torneo.name | lower }} badge">{{ torneo.estado_torneo.value | upper }}</span>
                    </div>

                    <div class="access-level-min">
                        <span class="value">{{ torneo.nivel_acceso_min }}</span>
                    </div>
                {% endmacro %}



                {{ render_data_card(torneo, card_type='torneo',
                    item_id=torneo.id_torneo,
                    item_name=torneo.nombre_torneo,
                    neon_color=torneo.juego.color_juego,
                    title=torneo.nombre_torneo | upper,
                    profile='ARENA',
                    subtitle='MAX_COMPETIDORES: ' ~ torneo.max_competidores,
                    edit_data_attributes={
                        'id': torneo.id_torneo,
                        'nombre': torneo.nombre_torneo,
                        'recompensa': torneo.recompensa_torneo,
                        'nivel_acceso_min': torneo.nivel_acceso_min,
                        'estado': torneo.estado_torneo.name,
                        'max_competidores': torneo.max_competidores,
                        'fecha_inicio': torneo.fecha_inicio.isoformat(),
                        'fecha_fin': torneo.fecha_fin.isoformat(),
                        'juego_id': torneo.id_juego},
                    card_header_content=card_header_content,
                    card_body_content=card_body_content,
                    card_footer_content=card_footer_content
                ) }}
            {% endfor %}
        {% else %}
            <!-- Mensaje si no hay ningún torneo creado todavía -->

            <div class="error-container">
                {%  include 'components/error-datos.html'%}
            </div>

        {% endif %}
    </div>

    {# Aquí irán los modales para crear y actualizar torneos en el futuro #}
    {{ render_torneo_modal(
            modal_id='createTorneoModal',
            form_action=url_for('torneo.create'),
            submit_text="CONFIRMAR_TORNEO",
            estados=estados,
            juegos_list=juegos_list,
            is_create=True
    ) }}
    {{ render_torneo_modal(
            modal_id='updateTorneoModal',
            form_action=url_for('torneo.update', id_torneo=0),
            submit_text="ACTUALIZAR_TORNEO",
            estados=estados,
            juegos_list=juegos_list
    ) }}
    {# {% include 'dashboard/torneos/create.html' %} #}
     {% include 'components/delete-modal.html' %}

    <script>
        // Función genérica para abrir/cerrar cualquier modal
        function toggleModal(modalID) {
            const modal = document.getElementById(modalID);
            if (modal) {
                modal.style.display = (modal.style.display === "none" || modal.style.display === "") ? "flex" : "none";
            }
        }


        function openUpdateModal(button) {
            // 1. Obtener datos del botón
            const id = button.getAttribute('data-id');
            const nombre = button.getAttribute('data-nombre');
            const recompensa = button.getAttribute('data-recompensa');
            const acceso_minimo = button.getAttribute('data-acceso_minimo');
            const estado = button.getAttribute('data-estado');
            const max_competidores = button.getAttribute('data-max_competidores');
            const fecha_inicio = button.getAttribute('data-fecha_inicio');
            const fecha_fin = button.getAttribute('data-fecha_fin');
            const juego_id = button.getAttribute('data-juego_id');
            // 2. Construir la URL de actualización dinámicamente
            const form = document.getElementById('form-updateTorneoModal'); // ID del form ahora es único
            const baseUrl = "{{ url_for('torneo.update', id_torneo=0) }}"; // URL base con '0'
            const updateUrl = baseUrl.replace('/0', '/' + id); // Reemplazo seguro

            // 3. Asignar valores a los inputs del formulario
            form.action = updateUrl;
            // Prefijamos el ID del input con el ID del modal para asegurar unicidad
            document.getElementById('updateTorneoModal-nombre').value = nombre;
            document.getElementById('updateTorneoModal-recompensa').value = recompensa;
            document.getElementById('updateTorneoModal-acceso_minimo').value = acceso_minimo;
            document.getElementById('updateTorneoModal-estado').value = estado;
            document.getElementById('updateTorneoModal-limite').value = max_competidores;
            document.getElementById('updateTorneoModal-inicio').value = fecha_inicio;
            document.getElementById('updateTorneoModal-fin').value = fecha_fin;
            document.getElementById('updateTorneoModal-juego').value = juego_id;


            // 4. Mostrar el modal
            toggleModal('updateTorneoModal');

        }

        function openDeleteModal(deleteUrl, itemName) {
            // 1. Actualizar el enlace del botón de confirmación
            document.getElementById('btnConfirmPurge').href = deleteUrl;

            // 2. Mostrar el nombre del rol en la advertencia
            document.getElementById('deleteItemName').textContent = itemName;

            // 3. Abrir el modal
            toggleModal('deleteConfirmationModal');
        }

    </script>

{% endblock %}