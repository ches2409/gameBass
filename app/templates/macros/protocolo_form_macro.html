{% macro render_protocolo_modal(modal_id, form_action, codigos_listado, categorias_listado, submit_text, is_create=False) %}
<!-- Fondo del Modal (Backdrop) -->
<div class="modal-overlay" id="{{ modal_id }}" style="display: none;">

  <!-- Contenedor del Modal -->
  <div class="modal-container">

    <!-- Elementos Decorativos de Esquina -->
    <div class="corner-bracket tl"></div>
    <div class="corner-bracket tr"></div>
    <div class="corner-bracket bl"></div>
    <div class="corner-bracket br"></div>

    <!-- Escáner Láser Decorativo (Animado) -->
    <div class="modal-laser-line"></div>

    <!-- Contenido del Formulario -->
    <div class="modal-content">

      <header class="modal-header">
        <div class="header-main">
          <span class="status-indicator"></span>
          <h2>INYECTAR_NUEVO_PROTOCOLO</h2>
        </div>
        <p class="header-subtitle">REESCRIBIENDO_MATRIZ_DE_PODER_v4.2</p>
      </header>

      <form class="injection-form" id="form-{{ modal_id }}" action="{{ form_action }}" method="POST">

        <!-- Campo: Codigo de protocolo -->
        <div class="input-group">
          <label><span class="label-icon">fingerprint</span> ID_SISTEMA_UNICO</label>
          <select name="codigo_de_protocolo" id="{{ modal_id }}-codigo" class="codigo_de_protocolo">
              {% for codigo in codigos_listado %}
                  <option value="{{ codigo.codigo }}">{{ codigo.codigo }}</option>
              {% endfor %}
          </select>
        </div>

        <!-- Campo: Nombre del Protocolo-->
        <div class="input-group">
          <label><span class="label-icon">badge</span> ETIQUETA_VISUAL</label>
          <input type="text" name="nombre_de_protocolo" id="{{ modal_id }}-nombre" {% if is_create %}placeholder="Ej: Global Shutdown"{% endif %} required>
          <div class="input-focus-line"></div>
        </div>

        <!-- Campo: Categoria -->
        <div class="input-group">
          <label><span class="label-icon">layers</span> CAPA_DE_SISTEMA</label>
          <select name="categoria_de_protocolo" id="{{ modal_id }}-categoria" class="categoria_de_protocolo">
              {% for categoria in categorias_listado %}
                  <option value="{{ categoria.name }}">{{ categoria.value | upper}}-CORE</option>
              {% endfor %}
          </select>
          <div class="input-focus-line"></div>

        </div>


        <!-- Descripción -->
        <div class="input-group">
          <label><span class="label-icon">terminal</span> MANIFIESTO_DE_EJECUCIÓN</label>
          <!-- Agregamos name y readonly -->
          <textarea name="descripcion_de_protocolo" id="{{ modal_id }}-descripcion" {% if is_create %}placeholder="Se asignará automáticamente según el ID_SISTEMA_UNICO..." {% endif %} readonly></textarea>
        </div>

        <!-- Botones de Acción -->
        <div class="modal-actions">
          <button type="button" class="btn-cancel" onclick="toggleModal('{{ modal_id }}')">ABORTAR_PROCESO</button>
          <button type="submit" class="btn-submit">
            <span class="btn-glow"></span>
            {{ submit_text }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endmacro %}